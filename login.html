<!-- Amanda Florian - 590673 -->

<!DOCTYPE html>
<html lang="en">
    
<head>
    
    <link href="style.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Autenticado - Auditoria de Sistemas</title>
</head>
<body>
    
 
    <div class="container">
        <div class="card">
            <h1>Entrar</h1>
        
            <div class="label-float">
                <input type="text" id="usuario" placeholder="" required>
                <label id="userLabel" for="usuario">Usuario</label>
            </div>
            <div class="label-float">
                <input type="text" id="senha" placeholder="" required>
                <label id="senhaLabel" for="senha">Senha</label>
            </div>

            <div class="justify-center">
                <button onclick='Entrar()'>Entrar</button>
            </div>

            <div class="justify-center">
                <hr>
            </div>

            <p>Não tem uma conta?
                <a href="cadastro.html">Cadastre-se</a>
            </p>

        </div>
    </div>

    <script>
        function Entrar() {
            var usuario = document.querySelector("#usuario");
            var userLabel = document.querySelector("#userLabel");
            var senha = document.querySelector("#senha");
            var senhaLabel = document.querySelector("#senhaLabel");
            var dataAtual = new Date()
            var diaLogin = dataAtual.getDate()
            var mesLogin = (dataAtual.getMonth()+1);
            var dataLogin = diaLogin + '/' + mesLogin
            var dadosSenha = document.getElementById('senha').value
            var dadosUser = document.getElementById('usuario').value
           
            var listaUser = [];
            var userValid = {
                nome: '',
                user: '',
                senha: ''
            };

            listaUser = JSON.parse(localStorage.getItem('listaUser'))

            listaUser.forEach((item) => {
                if(usuario.value == item.userCad && senha.value == item.senhaCad) {
                    userValid = {
                        nome: item.nomeCad,
                        user: item.userCad,
                        senha: item.senhaCad
                    }
                }
            });

            console.log(listaUser)

            if(usuario.value == userValid.user && senha.value == userValid.senha){
                alert('Ok')
                setTimeout(() => {
                    window.location.href = 'loginConcluido.html'
                }, 3000)
                var token = Math.random().toString(16).substr(2) + Math.random().toString(16).substr(2)
                localStorage.setItem('token', token)
                localStorage.setItem('userLogado', JSON.stringify(userValid))
                downloadFiles('logado.txt', dataLogin + ', ' + dadosUser + ', ' + dadosSenha + ', ' + token);
             
            } else {
                userLabel.setAttribute('style', 'color: red')
                senhaLabel.setAttribute('style', 'color: red')
                alert('Usuário ou senha incorretos')
                downloadFiles('erro.txt', dataLogin + ', ' + dadosUser + ', ' + dadosSenha);
                
            }
        }

        
        function downloadFiles(filename, text) {
           
            var element = document.createElement('a');
            
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename)

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();
            
            document.body.removeChild(element);
        }
        
    </script>
</body>
</html>